Проблема когерентности состоит в том, что при наличии в системе КЭШ-памяти одному исполнительному адресу соответствует более чем одно место хранения данных. Проблема возникает тогда, когда имеется более, чем одно устройство, способное модифицировать содержимое памяти. В этом случае одно устройство может изменить значение элемента (например, контроллер ПДП записывает блок данных в основную память), в то время как другое устройство (процессор), работая с другим экземпляром того же элемента данных, находящимся в КЭШе, будет использовать старое (неизмененное) значение. Понятно, что такие ситуации недопустимы.  
  
Рассмотрим, что следует сделать, если когерентность нарушается при модификации КЭШ-строки. В этом случае требуется: 
- записать (может быть с некоторой задержкой) измененное значение в основную память; 
- сбросить признаки достоверности в прочих копиях (КЭШ-памяти других процессоров системы, если таковые имеются).  

Для записи модифицированного данным процессором значения из его КЭШа в основную память используются две стратегии: 
- **сквозная запись** (write-through) 
- **обратная запись** (write-back).  

1. При `сквозной записи` перенос модифицируемого значения из КЭШа в ОЗУ происходит одновременно с изменением в КЭШе. Достоинство этой стратегии состоит в автоматическом обеспечении когерентности данного КЭШа и ОЗУ, а недостаток — в заметном снижении скорости (каждая запись безусловно идет в ОЗУ, даже если следующая команда снова будет модифицировать тот же элемент данных). На время обращения к ОЗУ дальнейшее выполнение программы приостанавливается. 

2. Существует модификация этой стратегии, называемая `буферизованной сквозной записью`, при которой копирование модифицированной КЭШ- строки в ОЗУ происходит не сразу, а через промежуточный буфер, работающий по схеме FIFO. Копирование в этот буфер происходит так же быстро, как и в КЭШ. При этом в многопроцессорной системе сразу же происходит сброс битов достоверности в КЭШ-памяти других процессоров. Перенос содержимого буфера в ОЗУ осуществляется затем параллельно с продолжением выполнения программы в те промежутки, когда данный процессор освобождает шину, связывающую его с основной памятью. В этом случае также возможны задержки (например, если следующее обращение к КЭШу тоже вызовет КЭШ-промах), однако это будет происходить реже, чем в отсутствие буфера.  
![[Pasted image 20250615130606.png]]

3. При использовании стратегии обратной записи перенос модифицированной КЭШ-строки в ОЗУ происходит только при ее замене, что в среднем случается реже, чем обращения к ней (в КЭШ). Как следствие, эта стратегия обеспечивает меньшую по сравнению со сквозной записью, долю обращений к ОЗУ, т.е. более высокую эффективность кэширования. Недостатки обратной записи: 
	- более сложная аппаратная реализация, 
	- сложнее обеспечить когерентность, 
	- при замене модифицированной строки возникает задержка, обусловленная необходимостью обращения к ОЗУ.  
![[Pasted image 20250615130902.png]]

`Способы обеспечения когерентности при записях в память со стороны другого активного агента – например, при **DMA / ПДП** (прямой доступ в память)`
### 1. «Запрет работы второго активного с кэшируемой областью»

Здесь речь о том, чтобы **сделать часть памяти некэшируемой**.
То есть, если устройство должно писать в память, ОС или аппарат помечают соответствующие страницы как некэшируемые, и ЦП **не кеширует эти области** → процессор всегда обращается напрямую к ОЗУ.
Это гарантирует актуальность, но **замедляет доступ для ЦП** — чтение/запись идет в основном через память, а не из кэша.

### 2. «При каждой операции внешней записи делается очистка кэша»
Здесь предлагается **сбросить (invalidate или flush)** всю кэшированную информацию или её часть при каждой записи устройства.  
То есть:
- Устройство пишет через DMA в память.
- После этого ЦП **сбрасывает (invalidate)** соответствующую область кэша.
- При следующем чтении участок будет загружен из ОЗУ — таким образом, не будет используются устаревшие данные.
➡️ Эффективно, но **очень дорого** — вызывает частые операции по сбросу кэш-линий, влечёт задержки.

### 3.«Прозрачность аппаратуры — аппаратный подход»
Это уже не просто политика памяти, а **аппаратная координация “сквозь кэш”** — два варианта:
#### а) Слежение за адресами записи 
- Аппаратура (чаще чипсет) **отслеживает**, что устройство пишет по определенному адресу.
- Если в кэше ЦП есть такие линии, они **сбрасываются (invalidate)** или **помечаются “грязными”**.
- В процессорах начиная с 486-ти через **snooping** (мониторинг шины) чипсет автоматически делает invalidate/flush-кэш-линию при операции DMA
b) Аппаратура не только сбрасывает строки в КЭШ, но и изменяет его содержимое при записи в ОЗУ.