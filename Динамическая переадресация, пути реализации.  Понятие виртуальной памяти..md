**1. Проблематика и возникновение виртуальной памяти**  
С развитием **мультипрограммных режимов** (пакетная обработка, разделение времени) в ЭВМ возникли две ключевые проблемы:
1. **Независимость подготовки программ:** Программист должен писать код, используя _любые_ адреса памяти, не зная, какие области ОЗУ будут заняты другими программами или ОС.
2. **Исключение взаимных помех (защита):** Программы не должны иметь возможности повредить память друг друга или операционной системы.

**Виртуальная память (ВП)** стала решением этих проблем. Ее основная идея: предоставить каждой программе **иллюзию** обладания собственным большим, непрерывным адресным пространством (**виртуальное адресное пространство - ВАП**), часто превышающим размер реальной физической памяти (ОЗУ).

**2. Суть виртуальной памяти**
- **Виртуальный ресурс:** ВП — это ресурс, который _представляется_ программе обладающим свойствами (большой размер, однородность, начиная с адреса 0), которыми реальная физическая память может не обладать.
- **Механизм реализации:** Основой ВП является **динамическая переадресация** (подмена адресов).
- **Транспарентность:** Механизм ВП полностью **прозрачен** для программиста. Он пишет код, работая с виртуальными адресами, а преобразование в физические и управление памятью берут на себя аппаратура (MMU - Memory Management Unit) и ОС.
- **Расширение памяти:** ВП позволяет программам использовать память, **превышающую объем ОЗУ**, за счет хранения неактивных частей программы (страниц, сегментов) на **вторичном хранилище** (обычно диске, в области **файла подкачки** или **раздела свопинга**).

**3. Динамическая переадресация: Механизм подмены адресов**  
Это аппаратно-реализуемый механизм, лежащий в основе ВП.

- **Два адресных пространства:**
    - **Логический (Виртуальный) Адрес (ЛА/ВА):** Адрес, который генерирует процессор при выполнении команды программы. Программа работает _только_ с ЛА.
    - **Физический Адрес (ФА):** Реальный адрес ячейки в оперативной памяти (ОЗУ).
![[Pasted image 20250615145507.png]]
- **Принцип работы:** При каждом обращении к памяти (чтение, запись, выборка команды) **блок управления памятью (MMU)** автоматически преобразует **Логический Адрес (ЛА)** в **Физический Адрес (ФА)** согласно правилам, заданным ОС.
- **Таблицы соответствия:** Преобразование ЛА → ФА происходит с использованием специальных структур данных в памяти – **таблиц соответствия** (страниц, сегментов). Эти таблицы описывают, как виртуальное адресное пространство программы отображается на физическую память и диск.
- **Защита:** Механизм переадресации обеспечивает **изоляцию процессов**. Программа _физически_ не может обратиться к адресу, не описанному в _ее_ таблицах соответствия. В таблицах также хранятся **биты прав доступа** (Read/Write/Execute).

**4. Пути реализации динамической переадресации и организации ВП**
Для эффективного преобразования адресов и управления памятью ВАП и физическая память разбиваются на блоки. Основные методы:

1. **Страничная организация (Paging):**
    - **Принцип:** ВАП _каждого процесса_ и _физическая память_ делятся на **фиксированные по размеру блоки** – **страницы** (обычно 4 КБ, размер = `2^n`).

    - **Адрес:** Логический адрес делится на две части:        
        - **Номер виртуальной страницы (Page Number - `p`):** Индекс в **таблице страниц** процесса.
        - **Смещение в странице (Offset - `d`):** Определяет конкретный байт внутри страницы (остается неизменным при преобразовании).
         ![[Pasted image 20250615145746.png]]   
    - **Таблица страниц:** Хранится в ОЗУ. Каждая запись (**PTE - Page Table Entry**) содержит:
        - **Номер физической страницы (Page Frame Number):** Если страница загружена в ОЗУ.
        - **Признак присутствия (Present bit):** `1` - страница в ОЗУ, `0` - страница на диске.
        - **Биты прав доступа (R/W/X).**
        - Прочие служебные биты (модификации, обращения и т.д.).
            
    - **Преобразование:** MMU использует `p` для нахождения PTE в таблице страниц. Если страница в ОЗУ (`Present=1`), берется номер фрейма, к нему прибавляется `d` – получается ФА.
    - **Пример:** Современные ОС общего назначения (Windows, Linux) в основном используют страничную организацию.
        
2. **Сегментная организация (Segmentation):**
    Механизм организации виртуальной памяти, при котором виртуальное пространство делится на части произвольного размера — сегменты. 
    
    Этот механизм позволяет, к примеру, разбить данные процесса на логические блоки. Для каждого сегмента, как и для страницы, могут быть назначены права доступа к нему пользователя и его процессов. При загрузке процесса часть сегментов помещается в оперативную память (при этом для каждого из этих сегментов операционная система подыскивает подходящий участок свободной памяти), а часть сегментов размещается в дисковой памяти. Сегменты одной программы могут занимать в оперативной памяти несмежные участки. Во время загрузки система создает таблицу сегментов процесса, в которой для каждого сегмента указывается начальный физический адрес сегмента в оперативной памяти, размер сегмента, правила доступа, признак модификации, признак обращения к данному сегменту за последний интервал времени и некоторая другая информация. Если виртуальные адресные пространства нескольких процессов включают один и тот же сегмент, то в таблицах сегментов этих процессов делаются ссылки на один и тот же участок оперативной памяти, в который данный сегмент загружается в единственном экземпляре. Система с сегментной организацией функционирует аналогично системе со страничной организацией: время от времени происходят прерывания, связанные с отсутствием нужных сегментов в памяти, при необходимости освобождения памяти некоторые сегменты выгружаются, при каждом обращении к оперативной памяти выполняется преобразование виртуального адреса в физический. Кроме того, при обращении к памяти проверяется, разрешен ли доступ требуемого типа к данному сегменту.

	Виртуальный адрес при сегментной организации памяти может быть представлен парой (g, s), где g — номер сегмента, а s — смещение в сегменте. Физический адрес получается путём сложения начального физического адреса сегмента, найденного в таблице сегментов по номеру g, и смещения s.
	
	Недостатком данного метода распределения памяти является фрагментация на уровне сегментов и более медленное по сравнению со страничной организацией преобразование адреса.

3. Сегментно-страничная организация памяти (делим на сегменты, а сегменты на страницы).
	
	Страница – физическая единица памяти, которая предназначена для эффективного использования ОП. Обработка страниц не связанна с содержанием этой страницы с точки зрения программ. На страничном уровне основная задача - эффективное управление памяти и отображение на внешнюю. 
	
	Сегмент – логическая единица, связанная со структурой программы и данных.
	
	Виртуальный сегмент – логическая единица, связанная с описанием сегментов в исходной программе. Сегментами оперирует система. Сегменты имеют свойства по характеру содержимого. 
	
	Сегментная организация  ориентирована на удовлетворение нужд программиста и для системных нужд.
	
	Сегментная виртуальная память позволяет учитывать свойства сегментов, управлять доступом к сегментам, создавать разделяемые области памяти.
	
	Возникает вопрос: где хранить таблицу соответствия? Таблицы соответствия (дескрипторная таблица) хранятся в оперативной памяти. Для ускорения процесса преобразования ЦП может использовать внутренний буфер (кэш таблиц)

Таким образом, **виртуальная память** - это совокупность программно-аппаратных средств, позволяющих пользователям писать программы, размер которых превосходит имеющуюся оперативную память; для этого виртуальная память решает следующие задачи: 
- размещает данные в запоминающих устройствах разного типа, например, часть программы в оперативной памяти, а часть на диске; (на диске выделяется специальная область – файл подкачки)
- перемещает по мере необходимости данные между запоминающими устройствами разного типа, например, подгружает нужную часть программы с диска в оперативную память; 
- преобразует виртуальные адреса в физические. 

Все эти действия выполняются автоматически, без участия программиста, то есть механизм виртуальной памяти является прозрачным по отношению к пользователю.  Наиболее распространенными реализациями виртуальной памяти является страничное, сегментное и странично-сегментное распределение памяти, а также свопинг.

***Свопинг*** – выгрузка сегментов из ОП на внешнюю память и обратно.