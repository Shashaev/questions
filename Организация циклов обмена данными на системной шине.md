**23.** **Организация циклов обмена данными на системной шине (из конспектов)**

В системную магистраль (системную шину) микропроцессорной системы входит три основные информационные шины: адреса, данных и управления. Для снижения общего количества линий связи магистрали часто применяется мультиплексирование шин адреса, данных и иногда части сигналов управления. То есть одни и те же линии связи используются в разные моменты времени для передачи разной информации. Для фиксации этих моментов (стробирования) служат специальные сигналы на шине управления, с помощью которых мы фактически переходим к классической трёх шинной архитектуре.

С точки зрения организации циклов передачи данных главными управляющим и сигналами являются стробы обмена, то есть сигналы, формируемые процессором и определяющие моменты времени, в которые производится пересылка данных по шине данных.

Для управления передачей данных необходимо указать направление передачи и момент передачи. Это можно реализовать двумя путями:

1- ввести отдельный сигнал направления передачи и строб момента передачи;

2- ввести два отдельных строба обмена:

- строб записи (вывода), который определяет момент времени, когда устройство-исполнитель может принимать данные, выставленные процессором на шину данных

- строб чтения (ввода), который определяет момент времени, когда устройство-исполнитель должно выдать на шину данных код данных, который будет прочитан процессором.

Независимо от способа стробирования передачи данных большое значение имеет то, как процессор заканчивает обмен в пределах цикла, в какой момент он снимает свои стробы обмена. Возможны два пути решения:

- процессор заканчивает обмен данными самостоятельно, через некоторый временной интервал, заложенный в его логику работы, то есть без учета интересов устройства-исполнителя, такой режим называют синхронным обменом;

- процессор заканчивает обмен только тогда, когда устройство исполнитель подтверждает выполнение операции специальным сигналом подтверждения, при этом длительность цикла будет определяться скоростными характеристиками устройств, участвующих в обмене. Такой режим называют асинхронным обменом (иногда такой режим называют режимом handshake — рукопожатие).

Достоинства синхронного обмена — более простой протокол обмена, меньшее количество управляющих сигналов. Недостатки — отсутствие гарантии, что исполнитель выполнил требуемую операцию. Для правильной работы системы необходимо что бы исполнитель был достаточно быстрым и вписывался во временное расписание процессора.

Достоинства асинхронного обмена — надежная пересылка данных, возможность работы с самыми разными по быстродействию исполнителями. Недостаток — необходимость формирования сигнала подтверждения, то есть дополнительные аппаратные затраты.

Сигнал подтверждения поступает на вход процессора и управляет длительностью цикла обмена. Логика работы процессора проста, он выставляет сигналы управления циклом на шину и переходит в ожидание сигнала подтверждения окончания операции от исполнителя (синхронизация от исполнителя), при получении подтверждения процессор заканчивает цикл обмена и освобождает системную шину. Такой подход позволяет работать как с быстрыми, так и с медленными исполнителями, но в случае неполучения процессором подтверждения система остается в состоянии ожидания (зависнет). Для исключения таких ситуаций в схему управления обменом вводят сторожевой таймер, который ограничивает время ожидания, формируя аварийный сигнал завершения цикла обмена.

В микропроцессорной технике сигнал подтверждения часто называют сигналом «готов».

При построении устройств возможны две стратегии управления сигналом «готов»: - нормально готовая система и нормально неготовая система.

В нормально готовой системе сигнал «готов» по умолчанию находится в состоянии готов и если не применять специальных мер по управлению сигналом «готов» процессор не будет переходить в ожидание и будет работать в синхронном режиме. Управление сигналом готовности при этом должно происходить только при обращении к медленным исполнителям.

В нормально неготовой системе сигнал готовности должен вырабатываться всеми исполнителями. Иначе будет зависание цикла.

Управление длительностью цикла на аппаратном уровне используется только при подключении устройств близких по скоростным характеристикам к характеристикам процессора. (ОП, регистры ввода-вывода). Большинство ВУ работают значительно медленнее процессора и переводить системную шину в ожидание на миллионы тактов процессора недопустимо. Очевидно необходимо использовать другие механизмы синхронизации процессов.

Обычно обмен в этих случаях организуется через буферную схему, которая отделяет системную шину от интерфейса ВУ. Обычно это набор регистров, в микропроцессорной технике этот буфер называется портом ввода-вывода (ПВВ).

Обмен данными с ВУ разделяется на две фазы: «системная шина – ПВВ» и «ПВВ – ВУ», которые выполняются на собственных скоростях не мешая друг другу. 



Так как процессы на системной шине и ВУ протекают независимо возникает проблема синхронизации этих процессов для определения моментов передачи данных по системной шине. Определение моментов передачи можно возложить на программу и тогда такой подход получил название - программный ввод-вывод

**Сокращенный ответ китайского друга:**

Системная шина включает шины адреса, данных и управления. Для экономии линий связи часто применяется мультиплексирование (совместное использование линий во времени для разных целей). Специальные сигналы управления стробируют моменты передачи, эмулируя классическую трехшинную структуру.

Основными сигналами управления циклами обмена являются **стробы обмена**, формируемые процессором. Они определяют момент передачи данных и могут реализовываться либо одним сигналом направления и одним стробом передачи, либо двумя отдельными стробами: **стробом записи** (сигнализирует устройству-исполнителю о моменте приема данных) и **стробом чтения** (сигнализирует о моменте выдачи данных процессору).

Завершение цикла обмена процессором может происходить двумя принципиально разными способами:

1. **Синхронный обмен:** Процессор завершает цикл самостоятельно через фиксированное время, без учета состояния устройства-исполнителя. Преимущества — простота протокола и меньше сигналов. Недостаток — отсутствие гарантии выполнения операции исполнителем, который должен быть достаточно быстрым.
2. **Асинхронный обмен (Handshake):** Процессор завершает цикл только после получения **сигнала подтверждения (готов)** от исполнителя. Длительность цикла адаптируется под устройство. Преимущества — надежность и работа с устройствами разной скорости. Недостаток — необходимость генерации сигнала подтверждения и риск зависания при его отсутствии (предотвращается сторожевым таймером).

Стратегии управления сигналом "готов":

- **Нормально готовая система:** Сигнал "готов" активен по умолчанию. Ожидание вводится только для медленных устройств.
- **Нормально неготовая система:** Сигнал "готов" должен генерироваться всеми исполнителями, иначе цикл зависнет.

Для работы с медленными внешними устройствами (ВУ), чья скорость значительно ниже процессорной, прямое управление длительностью цикла на шине неэффективно. Используются **порты ввода-вывода (ПВВ)**, выступающие буфером. Обмен разделяется на две независимые фазы: быстрый обмен "процессор ↔ ПВВ" по системной шине и медленный обмен "ПВВ ↔ ВУ".