
### Fail-over (отказоустойчивые) - Отказоустойчивый кластер

### **Summary**  
Задача отказоустойчивого кластера — обеспечение доступности сервиса в сети за счет минимально-необходимого времени восстановления после сбоя или отказа любого происхождения (пожар, аппаратная ошибка, атака и др.). Время восстановления сервиса в таком кластере, как правило, не должно превышать нескольких минут, а в ряде случаев, в зависимости от требований, и секунд. Суть работы отказоустойчивого кластера заключается в способности отслеживать состояние узлов кластера и запущенных сервисов и, при обнаружении отказа, перезапуска сервисов на свободных узлах кластера.

Задачи:

1.обнаружение отказа

2 изоляция отказавшего узла

3 переключение на рабочие узлы

4.восстановление выч.процесса

Классическая схема отказоустойчивого кластера содержит минимум два узла и общее дисковое хранилище данных (например SAN), связанных между собой несколькими сетевыми соединениями.

![[Pasted image 20250615213245.png]]

Рис 4. Структура отказоустойчивого кластера.

### **Подробно**

Наиболее правильным названием является -  кластер высокой доступности ([англ.](https://ru.wikipedia.org/wiki/%D0%90%D0%BD%D0%B3%D0%BB%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9_%D1%8F%D0%B7%D1%8B%D0%BA "Английский язык") High-Availability cluster, HA cluster). HA [кластер](https://ru.wikipedia.org/wiki/%D0%9A%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80_\(%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0_%D0%BA%D0%BE%D0%BC%D0%BF%D1%8C%D1%8E%D1%82%D0%B5%D1%80%D0%BE%D0%B2\) "Кластер (группа компьютеров)") (группа [серверов](https://ru.wikipedia.org/wiki/%D0%A1%D0%B5%D1%80%D0%B2%D0%B5%D1%80_\(%D0%B0%D0%BF%D0%BF%D0%B0%D1%80%D0%B0%D1%82%D0%BD%D0%BE%D0%B5_%D0%BE%D0%B1%D0%B5%D1%81%D0%BF%D0%B5%D1%87%D0%B5%D0%BD%D0%B8%D0%B5\) "Сервер (аппаратное обеспечение)")), спроектированный в соответствии с методиками обеспечения [высокой доступности](https://ru.wikipedia.org/wiki/%D0%92%D1%8B%D1%81%D0%BE%D0%BA%D0%B0%D1%8F_%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D0%BE%D1%81%D1%82%D1%8C "Высокая доступность") и гарантирующий минимальное время простоя за счёт аппаратной избыточности.

 Без кластеризации сбой сервера приводит к тому, что поддерживаемые им [приложения](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D0%BA%D0%BB%D0%B0%D0%B4%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%BD%D0%BE%D0%B5_%D0%BE%D0%B1%D0%B5%D1%81%D0%BF%D0%B5%D1%87%D0%B5%D0%BD%D0%B8%D0%B5 "Прикладное программное обеспечение") или [сетевые сервисы](https://ru.wikipedia.org/wiki/%D0%A1%D0%B5%D1%82%D0%B5%D0%B2%D1%8B%D0%B5_%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B "Сетевые сервисы") оказываются недоступны до восстановления его работоспособности. Отказоустойчивая кластеризация исправляет эту ситуацию, перезапуская приложения на других узлах кластера без вмешательства администратора в случае обнаружения аппаратных или программных сбоев. Процесс перезапуска известен как [аварийное переключение](https://ru.wikipedia.org/wiki/%D0%90%D0%B2%D0%B0%D1%80%D0%B8%D0%B9%D0%BD%D0%BE%D0%B5_%D0%BF%D0%B5%D1%80%D0%B5%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5 "Аварийное переключение"). В рамках этого процесса программное обеспечение кластеризации может дополнительно настроить узел перед запуском приложения на нём (например, импортировать и смонтировать соответствующие файловые системы, переконфигурировать сетевое оборудование или запустить какие-либо служебные приложения).

Отказоустойчивые кластеры широко используются для поддержки важных [баз данных](https://ru.wikipedia.org/wiki/%D0%91%D0%B0%D0%B7%D0%B0_%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85 "База данных"), хранения файлов в сети, бизнес-приложений и систем обслуживания клиентов, таких как [сайты](https://ru.wikipedia.org/wiki/%D0%A1%D0%B0%D0%B9%D1%82 "Сайт") [электронной коммерции](https://ru.wikipedia.org/wiki/%D0%AD%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%BE%D0%BD%D0%BD%D0%B0%D1%8F_%D0%BA%D0%BE%D0%BC%D0%BC%D0%B5%D1%80%D1%86%D0%B8%D1%8F "Электронная коммерция").

Определение отказа машины осуществляется путем слежения за ее активностью.

Для этого используется генерация и передача по специальному интерфейсу (на схеме показана красным) сигнала сердцебиения **(heartbeat)**, по которому определяется состояние машины (в недорогих решениях сигнал может передаваться по общей сети).

 Для генерации сигнала сердцебиения в рабочей машине запускается фоновая программа, которая  через определенные промежутки времени, генерирует в линию связи, доступную другим машинам, короткие сообщения (сигнал сердцебиения), на  второй машине запускается таймер (программный или аппаратный) на промежуток времени  незначительно превышающий период сердцебиения, при потере сигнала сердцебиения принимается решение о выходе машины из строя.

По схеме работы кластера узлы могут работать в режиме **активный-пассивный** или **активный-активный**.

 В первом случае все клиентские запросы обслуживаются одним из узлов, второй узел является резервным и вступает в работу только при отказе первого.

Второй вариант предусматривает обработку клиентских запросов обоими узлами, при этом также можно осуществлять балансировку нагрузки и увеличивать вычислительные ресурсы, путем добавления новых узлов кластера. В такой системе осуществляется взаимное слежение за активностью. В случае отказа одного из узлов клиентские запросы обрабатывают оставшиеся узлы кластера.

Важный момент - каждый клиентский запрос обслуживается только одним из узлов кластера и в случае его выхода из строя подключенные клиенты получат отказ в обслуживании, однако они могут тут же автоматически переключиться на оставшиеся доступными узлы. Переключение запросов клиентов возможно с помощью средств балансировки нагрузки.

Если на узле выполняется какое-то приложение (расчеты, моделирование, сапр), то перезапуск приложения, при переключении на работающую машину, возможен путем использования любого подхода к восстановлению вычислительного процесса (допустим с контрольной точки восстановления процесса). Правда, такой подход будет иметь некоторое время восстановления  вычислительного процесса, тем большее, чем реже мы будем формировать точки восстановления. Для того что бы это сделать мы должны иметь, одинаковые данные в дисковой памяти машин, либо использовать общий доступ к дискам.

При построении отказоустойчивых кластеров необходимо рассматривать и возможность отказов всей инфраструктуры. В ней не должно быть единой точки отказа, то есть такого места, отказ которого приведет к отказу всей системы, это касается и системы хранения данных и сетевой структуры.

Пример построения отказоустойчивого кластера показан на рисунке.

  
Данная схема отображает кластер с отсутствующими точками отказа (null point of failure), то есть в системе нет такого узла, отказ которого повлек бы отказ системы.  На схеме оба RAID-массива функционируют в режиме зеркала между собой, так что отказ одного массива не повлечет отказа системы.

Если задача стоит в создании системы нечувствительной к отказам (с нулевым временем восстановления), придется использовать другие подходы к решению задачи, например, синхронное параллельное выполнение задачи на двух или нескольких машинах и переключение на съем результатов с рабочей машины.

Доп. информация - [https://medium.com/southbridge/introduction-to-modern-network-load-balancing-and-proxying-52e8ca36adde](https://medium.com/southbridge/introduction-to-modern-network-load-balancing-and-proxying-52e8ca36adde)

### Deepseek

Построение отказоустойчивых кластеров в ЭВМ требует комплексного подхода, включающего аппаратные и программные решения. Основные методики можно разделить на несколько категорий:  

### **1. Репликация (Replication)**  
**Принцип:** Создание копий данных или сервисов на нескольких узлах кластера.  
- **Синхронная репликация** – данные записываются на все узлы одновременно (высокая согласованность, но меньшая производительность).  
- **Асинхронная репликация** – данные сначала записываются на главный узел, затем реплицируются (лучшая производительность, но возможна потеря данных при сбое).  

**Примеры:**  
- Базы данных (PostgreSQL, MongoDB, Cassandra).  
- Файловые системы (Ceph, GlusterFS).  

### **2. Файловые и распределённые системы хранения**  
**Принцип:** Использование отказоустойчивых СХД (Storage Area Network, NAS) или распределённых файловых систем.  
- **RAID** (избыточные массивы дисков) – защита от отказа жёстких дисков.  
- **Distributed File Systems** (HDFS, Ceph) – данные распределены между узлами с репликацией.  

### **3. Высокая доступность (High Availability, HA)**  
**Принцип:** Обеспечение бесперебойной работы сервисов при отказе узлов.  
- **Active-Passive** – один узел активен, другие в режиме ожидания (переключение при сбое).  
- **Active-Active** – все узлы обрабатывают запросы, нагрузка распределяется (более сложная настройка).  

**Технологии:**  
- **Keepalived + VRRP** – виртуальный IP-адрес переключается между узлами.  
- **Pacemaker + Corosync** – кластерный менеджер ресурсов.  
- **Kubernetes с Pod Anti-Affinity** – распределение подов по разным узлам.  

### **4. Кворум и консенсус-алгоритмы**  
**Принцип:** Предотвращение split-brain (ситуации, когда узлы не могут договориться).  
- **Paxos, Raft** – алгоритмы консенсуса (используются в etcd, Consul).  
- **Кворумная запись** – данные считаются записанными, если подтверждены большинством узлов.  

### **5. Контейнеризация и оркестрация**  
**Принцип:** Изоляция сервисов и автоматическое восстановление.  
- **Kubernetes** – самовосстановление подов, репликация, балансировка.  
- **Docker Swarm** – более простая альтернатива для кластеризации.  

### **6. Геораспределённые кластеры (Disaster Recovery)**  
**Принцип:** Защита от катастрофических сбоев (например, выход из строя дата-центра).  
- **Multi-DC репликация** (например, MongoDB с шардированием между ЦОД).  
- **Глобальные балансировщики (GSLB)** – автоматическое переключение трафика между регионами.  

### **7. Мониторинг и автоматическое восстановление**  
**Принцип:** Обнаружение и устранение сбоев без вмешательства человека.  
- **Prometheus + Alertmanager** – мониторинг и оповещения.  
- **Ansible / Terraform** – автоматическое развёртывание и восстановление инфраструктуры.  

